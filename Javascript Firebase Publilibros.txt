const firebaseConfig = {
    apiKey: "AIzaSyDjwZHNY-q6kp67MzUOMQ4olOW3CgtNL0U",
    authDomain: "publilibros01.firebaseapp.com",
    projectId: "publilibros01",
    storageBucket: "publilibros01.firebasestorage.app",
    messagingSenderId: "242974271454",
    appId: "1:242974271454:web:ae939c47d714ccb6185f4f",
    measurementId: "G-CSLWHDQ3Q6"
};

try {
    // Inicializar Firebase solo si no está ya inicializado
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase inicializado correctamente");
    } else {
        console.log("Firebase ya estaba inicializado");
    }
} catch (error) {
    console.error("Error inicializando Firebase:", error);
}

// Referencias globales seguras
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Configuración de persistencia de sesión
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => console.log("Persistencia de sesión configurada"))
    .catch((error) => console.error("Error en persistencia:", error));

// Habilitar índices para Firestore
db.settings({
    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
});

// Manejo de errores global de Firebase
const handleFirebaseError = (error) => {
    console.error("Error de Firebase:", error);
    
    const errorMessages = {
        'auth/invalid-email': 'El email no es válido',
        'auth/user-disabled': 'Esta cuenta ha sido deshabilitada',
        'auth/user-not-found': 'Usuario no encontrado',
        'auth/wrong-password': 'Contraseña incorrecta',
        'auth/email-already-in-use': 'Este email ya está registrado',
        'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres',
        'auth/network-request-failed': 'Error de conexión. Verifica tu internet',
        'permission-denied': 'No tienes permisos para realizar esta acción',
        'unavailable': 'Servicio temporalmente no disponible'
    };
    
    return errorMessages[error.code] || `Error: ${error.message}`;
};

// Verificar estado de Firebase
const checkFirebaseStatus = async () => {
    try {
        await auth.signInAnonymously();
        await auth.signOut();
        return { status: 'ok', message: 'Firebase conectado correctamente' };
    } catch (error) {
        return { 
            status: 'error', 
            message: handleFirebaseError(error),
            error: error 
        };
    }
};

// Exportar para usar en otros archivos
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { firebaseConfig, auth, db, storage, handleFirebaseError, checkFirebaseStatus };
}